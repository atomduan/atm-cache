echo "checking for perl"


ATM_PERL_VER=`$ATM_PERL -v 2>&1 | grep '^This is perl' 2>&1 \
                                | sed -e 's/^This is perl, \(.*\)/\1/'`

if test -n "$ATM_PERL_VER"; then
    echo " + perl version: $ATM_PERL_VER"

    if [ "`$ATM_PERL -e 'use 5.008006; print "OK"'`" != "OK" ]; then
        echo
        echo "$0: error: perl 5.8.6 or higher is required"
        echo

        exit 1;
    fi

    if [ "`$ATM_PERL -MExtUtils::Embed -e 'print "OK"'`" != "OK" ]; then
        echo
        echo "$0: error: perl module ExtUtils::Embed is required"
        echo

        exit 1;
    fi

    ATM_PM_CFLAGS=`$ATM_PERL -MExtUtils::Embed -e ccopts`
    ATM_PM_LDFLAGS=`$ATM_PERL -MConfig -e 'print $Config{lddlflags}'`

    ATM_PERL_CFLAGS="$CFLAGS `$ATM_PERL -MExtUtils::Embed -e ccopts`"

    # gcc 4.1/4.2 warn about unused values in pTHX_
    ATM_PERL_CFLAGS=`echo $ATM_PERL_CFLAGS \
                     | sed -e 's/-Wunused-value/-Wno-unused-value/'`
    # icc8 warns 'declaration hides parameter "my_perl"' in ENTER and LEAVE
    ATM_PERL_CFLAGS=`echo $ATM_PERL_CFLAGS \
                     | sed -e 's/-wd171/-wd171 -wd1599/'`

    atm_perl_ldopts=`$ATM_PERL -MExtUtils::Embed -e ldopts`

    atm_perl_dlext=`$ATM_PERL -MConfig -e 'print $Config{dlext}'`
    atm_perl_libdir="src/http/modules/perl/blib/arch/auto"
    atm_perl_module="$atm_perl_libdir/atmcache/atmcache.$atm_perl_dlext"

    if $ATM_PERL -V:usemultiplicity | grep define > /dev/null; then
        have=ATM_HAVE_PERL_MULTIPLICITY . auto/have
        echo " + perl interpreter multiplicity found"
    fi

    if $ATM_PERL -V:useithreads | grep undef > /dev/null; then
        # FreeBSD port wants to link with -pthread non-threaded perl
        atm_perl_ldopts=`echo $atm_perl_ldopts | sed 's/ -pthread//'`
    fi

    if [ "$ATM_SYSTEM" = "Darwin" ]; then
        # OS X system perl wants to link universal binaries
        atm_perl_ldopts=`echo $atm_perl_ldopts \
                         | sed -e 's/-arch i386//' -e 's/-arch x86_64//'`
    fi

    if [ $USE_PERL = YES ]; then
        CORE_LINK="$CORE_LINK $atm_perl_ldopts"
    fi

    ATM_LIB_PERL="$atm_perl_ldopts"

    if test -n "$ATM_PERL_MODULES"; then
        have=ATM_PERL_MODULES value="(u_char *) \"$ATM_PERL_MODULES\""
        . auto/define
        ATM_PERL_MODULES_MAN=$ATM_PERL_MODULES/man3
    fi

else
    echo
    echo "$0: error: perl 5.8.6 or higher is required"
    echo

    exit 1;
fi
