
# Copyright (C) Igor Sysoev
# Copyright (C) Nginx, Inc.


if [ $EVENT_SELECT = NO -a $EVENT_FOUND = NO ]; then
    EVENT_SELECT=YES
fi

if [ $EVENT_SELECT = YES ]; then
    have=ATM_HAVE_SELECT . auto/have
    CORE_SRCS="$CORE_SRCS $SELECT_SRCS"
    EVENT_MODULES="$EVENT_MODULES $SELECT_MODULE"
fi


if [ $EVENT_POLL = NO -a $EVENT_FOUND = NO ]; then
    EVENT_POLL=YES
fi

if [ $EVENT_POLL = YES ]; then
    have=ATM_HAVE_POLL . auto/have
    CORE_SRCS="$CORE_SRCS $POLL_SRCS"
    EVENT_MODULES="$EVENT_MODULES $POLL_MODULE"
fi


if [ $ATM_TEST_BUILD_DEVPOLL = YES ]; then
    have=ATM_HAVE_DEVPOLL . auto/have
    have=ATM_TEST_BUILD_DEVPOLL . auto/have
    EVENT_MODULES="$EVENT_MODULES $DEVPOLL_MODULE"
    CORE_SRCS="$CORE_SRCS $DEVPOLL_SRCS"
fi


if [ $ATM_TEST_BUILD_EVENTPORT = YES ]; then
    have=ATM_HAVE_EVENTPORT . auto/have
    have=ATM_TEST_BUILD_EVENTPORT . auto/have
    EVENT_MODULES="$EVENT_MODULES $EVENTPORT_MODULE"
    CORE_SRCS="$CORE_SRCS $EVENTPORT_SRCS"
fi

if [ $ATM_TEST_BUILD_EPOLL = YES ]; then
    have=ATM_HAVE_EPOLL . auto/have
    have=ATM_HAVE_EPOLLRDHUP . auto/have
    have=ATM_HAVE_EPOLLEXCLUSIVE . auto/have
    have=ATM_HAVE_EVENTFD . auto/have
    have=ATM_TEST_BUILD_EPOLL . auto/have
    EVENT_MODULES="$EVENT_MODULES $EPOLL_MODULE"
    CORE_SRCS="$CORE_SRCS $EPOLL_SRCS"
fi

if [ $ATM_TEST_BUILD_SOLARIS_SENDFILEV = YES ]; then
    have=ATM_TEST_BUILD_SOLARIS_SENDFILEV . auto/have
    CORE_SRCS="$CORE_SRCS $SOLARIS_SENDFILEV_SRCS"
fi


HTTP_MODULES=
HTTP_DEPS=
HTTP_INCS=

atm_module_type=HTTP

if :; then
    atm_module_name="atm_http_module \
                     atm_http_core_module \
                     atm_http_log_module \
                     atm_http_upstream_module"
    atm_module_incs="src/http src/http/modules"
    atm_module_deps="src/http/atm_http.h \
                     src/http/atm_http_request.h \
                     src/http/atm_http_config.h \
                     src/http/atm_http_core_module.h \
                     src/http/atm_http_cache.h \
                     src/http/atm_http_variables.h \
                     src/http/atm_http_script.h \
                     src/http/atm_http_upstream.h \
                     src/http/atm_http_upstream_round_robin.h"
    atm_module_srcs="src/http/atm_http.c \
                     src/http/atm_http_core_module.c \
                     src/http/atm_http_special_response.c \
                     src/http/atm_http_request.c \
                     src/http/atm_http_parse.c \
                     src/http/modules/atm_http_log_module.c \
                     src/http/atm_http_request_body.c \
                     src/http/atm_http_variables.c \
                     src/http/atm_http_script.c \
                     src/http/atm_http_upstream.c \
                     src/http/atm_http_upstream_round_robin.c"
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi


if [ $HTTP != YES ]; then
    have=ATM_CRYPT . auto/nohave
    CRYPT_LIB=
fi


if [ $HTTP_CACHE = YES ]; then
    have=ATM_HTTP_CACHE . auto/have
    HTTP_SRCS="$HTTP_SRCS $HTTP_FILE_CACHE_SRCS"
fi


if [ $HTTP_SSI = YES ]; then
    HTTP_POSTPONE=YES
fi


if [ $HTTP_SLICE = YES ]; then
    HTTP_POSTPONE=YES
fi


if [ $HTTP_ADDITION = YES ]; then
    HTTP_POSTPONE=YES
fi


# the module order is important
#     atm_http_static_module
#     atm_http_gzip_static_module
#     atm_http_dav_module
#     atm_http_autoindex_module
#     atm_http_index_module
#     atm_http_random_index_module
#
#     atm_http_access_module
#     atm_http_realip_module
#
#
# the filter order is important
#     atm_http_write_filter
#     atm_http_header_filter
#     atm_http_chunked_filter
#     atm_http_v2_filter
#     atm_http_range_header_filter
#     atm_http_gzip_filter
#     atm_http_postpone_filter
#     atm_http_ssi_filter
#     atm_http_charset_filter
#         atm_http_xslt_filter
#         atm_http_image_filter
#         atm_http_sub_filter
#         atm_http_addition_filter
#         atm_http_gunzip_filter
#         atm_http_userid_filter
#         atm_http_headers_filter
#     atm_http_copy_filter
#     atm_http_range_body_filter
#     atm_http_not_modified_filter
#     atm_http_slice_filter

atm_module_type=HTTP_FILTER
HTTP_FILTER_MODULES=

atm_module_order="atm_http_static_module \
                  atm_http_gzip_static_module \
                  atm_http_dav_module \
                  atm_http_autoindex_module \
                  atm_http_index_module \
                  atm_http_random_index_module \
                  atm_http_access_module \
                  atm_http_realip_module \
                  atm_http_write_filter_module \
                  atm_http_header_filter_module \
                  atm_http_chunked_filter_module \
                  atm_http_v2_filter_module \
                  atm_http_range_header_filter_module \
                  atm_http_gzip_filter_module \
                  atm_http_postpone_filter_module \
                  atm_http_ssi_filter_module \
                  atm_http_charset_filter_module \
                  atm_http_xslt_filter_module \
                  atm_http_image_filter_module \
                  atm_http_sub_filter_module \
                  atm_http_addition_filter_module \
                  atm_http_gunzip_filter_module \
                  atm_http_userid_filter_module \
                  atm_http_headers_filter_module \
                  atm_http_copy_filter_module \
                  atm_http_range_body_filter_module \
                  atm_http_not_modified_filter_module \
                  atm_http_slice_filter_module"

if :; then
    atm_module_name=atm_http_write_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/atm_http_write_filter_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if :; then
    atm_module_name=atm_http_header_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/atm_http_header_filter_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if :; then
    atm_module_name=atm_http_chunked_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_chunked_filter_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if [ $HTTP_V2 = YES ]; then
    atm_module_name=atm_http_v2_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/v2/atm_http_v2_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_V2

    . auto/module
fi

if :; then
    atm_module_name=atm_http_range_header_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_range_filter_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if [ $HTTP_GZIP = YES ]; then
    have=ATM_HTTP_GZIP . auto/have
    USE_ZLIB=YES

    atm_module_name=atm_http_gzip_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_gzip_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_GZIP

    . auto/module
fi

if [ $HTTP_POSTPONE = YES ]; then
    atm_module_name=atm_http_postpone_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/atm_http_postpone_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_POSTPONE

    . auto/module
fi

if [ $HTTP_SSI = YES ]; then
    have=ATM_HTTP_SSI . auto/have

    atm_module_name=atm_http_ssi_filter_module
    atm_module_incs=
    atm_module_deps=src/http/modules/atm_http_ssi_filter_module.h
    atm_module_srcs=src/http/modules/atm_http_ssi_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_SSI

    . auto/module
fi

if [ $HTTP_CHARSET = YES ]; then
    atm_module_name=atm_http_charset_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_charset_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_CHARSET

    . auto/module
fi

if [ $HTTP_XSLT != NO ]; then
    atm_module_name=atm_http_xslt_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_xslt_filter_module.c
    atm_module_libs=LIBXSLT
    atm_module_link=$HTTP_XSLT

    . auto/module
fi

if [ $HTTP_IMAGE_FILTER != NO ]; then
    atm_module_name=atm_http_image_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_image_filter_module.c
    atm_module_libs=LIBGD
    atm_module_link=$HTTP_IMAGE_FILTER

    . auto/module
fi

if [ $HTTP_SUB = YES ]; then
    atm_module_name=atm_http_sub_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_sub_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_SUB

    . auto/module
fi

if [ $HTTP_ADDITION = YES ]; then
    atm_module_name=atm_http_addition_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_addition_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_ADDITION

    . auto/module
fi

if [ $HTTP_GUNZIP = YES ]; then
    have=ATM_HTTP_GZIP . auto/have
    USE_ZLIB=YES

    atm_module_name=atm_http_gunzip_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_gunzip_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_GUNZIP

    . auto/module
fi

if [ $HTTP_USERID = YES ]; then
    atm_module_name=atm_http_userid_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_userid_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_USERID

    . auto/module
fi

if :; then
    atm_module_name=atm_http_headers_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_headers_filter_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi


atm_module_type=HTTP_INIT_FILTER
HTTP_INIT_FILTER_MODULES=

if :; then
    atm_module_name=atm_http_copy_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/atm_http_copy_filter_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if :; then
    atm_module_name=atm_http_range_body_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if :; then
    atm_module_name=atm_http_not_modified_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_not_modified_filter_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if [ $HTTP_SLICE = YES ]; then
    atm_module_name=atm_http_slice_filter_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_slice_filter_module.c
    atm_module_libs=
    atm_module_link=$HTTP_SLICE

    . auto/module
fi


atm_module_type=HTTP

if [ $HTTP_V2 = YES ]; then
    have=ATM_HTTP_V2 . auto/have

    atm_module_name=atm_http_v2_module
    atm_module_incs=src/http/v2
    atm_module_deps="src/http/v2/atm_http_v2.h src/http/v2/atm_http_v2_module.h"
    atm_module_srcs="src/http/v2/atm_http_v2.c \
                     src/http/v2/atm_http_v2_table.c \
                     src/http/v2/atm_http_v2_huff_decode.c \
                     src/http/v2/atm_http_v2_huff_encode.c \
                     src/http/v2/atm_http_v2_module.c"
    atm_module_libs=
    atm_module_link=$HTTP_V2

    . auto/module
fi

if :; then
    atm_module_name=atm_http_static_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_static_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if [ $HTTP_GZIP_STATIC = YES ]; then
    have=ATM_HTTP_GZIP . auto/have

    atm_module_name=atm_http_gzip_static_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_gzip_static_module.c
    atm_module_libs=
    atm_module_link=$HTTP_GZIP_STATIC

    . auto/module
fi

if [ $HTTP_DAV = YES ]; then
    have=ATM_HTTP_DAV . auto/have

    atm_module_name=atm_http_dav_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_dav_module.c
    atm_module_libs=
    atm_module_link=$HTTP_DAV

    . auto/module
fi

if [ $HTTP_AUTOINDEX = YES ]; then
    atm_module_name=atm_http_autoindex_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_autoindex_module.c
    atm_module_libs=
    atm_module_link=$HTTP_AUTOINDEX

    . auto/module
fi

if :; then
    atm_module_name=atm_http_index_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_index_module.c
    atm_module_libs=
    atm_module_link=YES

    . auto/module
fi

if [ $HTTP_RANDOM_INDEX = YES ]; then
    atm_module_name=atm_http_random_index_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_random_index_module.c
    atm_module_libs=
    atm_module_link=$HTTP_RANDOM_INDEX

    . auto/module
fi

if [ $HTTP_AUTH_REQUEST = YES ]; then
    atm_module_name=atm_http_auth_request_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_auth_request_module.c
    atm_module_libs=
    atm_module_link=$HTTP_AUTH_REQUEST

    . auto/module
fi

if [ $HTTP_AUTH_BASIC = YES ]; then
    have=ATM_CRYPT . auto/have

    atm_module_name=atm_http_auth_basic_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_auth_basic_module.c
    atm_module_libs=$CRYPT_LIB
    atm_module_link=$HTTP_AUTH_BASIC

    . auto/module
fi

if [ $HTTP_ACCESS = YES ]; then
    atm_module_name=atm_http_access_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_access_module.c
    atm_module_libs=
    atm_module_link=$HTTP_ACCESS

    . auto/module
fi

if [ $HTTP_LIMIT_CONN = YES ]; then
    atm_module_name=atm_http_limit_conn_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_limit_conn_module.c
    atm_module_libs=
    atm_module_link=$HTTP_LIMIT_CONN

    . auto/module
fi

if [ $HTTP_LIMIT_REQ = YES ]; then
    atm_module_name=atm_http_limit_req_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_limit_req_module.c
    atm_module_libs=
    atm_module_link=$HTTP_LIMIT_REQ

    . auto/module
fi

if [ $HTTP_REALIP = YES ]; then
    have=ATM_HTTP_REALIP . auto/have
    have=ATM_HTTP_X_FORWARDED_FOR . auto/have

    atm_module_name=atm_http_realip_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_realip_module.c
    atm_module_libs=
    atm_module_link=$HTTP_REALIP

    . auto/module
fi

if [ $HTTP_STATUS = YES ]; then
    atm_module_name=atm_http_status_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_status_module.c
    atm_module_libs=
    atm_module_link=$HTTP_STATUS

    . auto/module
fi

if [ $HTTP_GEO = YES ]; then
    have=ATM_HTTP_X_FORWARDED_FOR . auto/have

    atm_module_name=atm_http_geo_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_geo_module.c
    atm_module_libs=
    atm_module_link=$HTTP_GEO

    . auto/module
fi

if [ $HTTP_GEOIP != NO ]; then
    have=ATM_HTTP_X_FORWARDED_FOR . auto/have

    atm_module_name=atm_http_geoip_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_geoip_module.c
    atm_module_libs=GEOIP
    atm_module_link=$HTTP_GEOIP

    . auto/module
fi

if [ $HTTP_MAP = YES ]; then
    atm_module_name=atm_http_map_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_map_module.c
    atm_module_libs=
    atm_module_link=$HTTP_MAP

    . auto/module
fi

if [ $HTTP_SPLIT_CLIENTS = YES ]; then
    atm_module_name=atm_http_split_clients_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_split_clients_module.c
    atm_module_libs=
    atm_module_link=$HTTP_SPLIT_CLIENTS

    . auto/module
fi

if [ $HTTP_REFERER = YES ]; then
    atm_module_name=atm_http_referer_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_referer_module.c
    atm_module_libs=
    atm_module_link=$HTTP_REFERER

    . auto/module
fi

if [ $HTTP_REWRITE = YES -a $USE_PCRE != DISABLED ]; then
    USE_PCRE=YES

    atm_module_name=atm_http_rewrite_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_rewrite_module.c
    atm_module_libs=
    atm_module_link=$HTTP_REWRITE

    . auto/module
fi

if [ $HTTP_SSL = YES ]; then
    USE_OPENSSL=YES
    have=ATM_HTTP_SSL . auto/have

    atm_module_name=atm_http_ssl_module
    atm_module_incs=
    atm_module_deps=src/http/modules/atm_http_ssl_module.h
    atm_module_srcs=src/http/modules/atm_http_ssl_module.c
    atm_module_libs=
    atm_module_link=$HTTP_SSL

    . auto/module
fi

if [ $HTTP_PROXY = YES ]; then
    have=ATM_HTTP_X_FORWARDED_FOR . auto/have

    atm_module_name=atm_http_proxy_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_proxy_module.c
    atm_module_libs=
    atm_module_link=$HTTP_PROXY

    . auto/module
fi

if [ $HTTP_FASTCGI = YES ]; then
    atm_module_name=atm_http_fastcgi_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_fastcgi_module.c
    atm_module_libs=
    atm_module_link=$HTTP_FASTCGI

    . auto/module
fi

if [ $HTTP_UWSGI = YES ]; then
    atm_module_name=atm_http_uwsgi_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_uwsgi_module.c
    atm_module_libs=
    atm_module_link=$HTTP_UWSGI

    . auto/module
fi

if [ $HTTP_SCGI = YES ]; then
    atm_module_name=atm_http_scgi_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_scgi_module.c
    atm_module_libs=
    atm_module_link=$HTTP_SCGI

    . auto/module
fi

if [ $HTTP_PERL != NO ]; then
    atm_module_name=atm_http_perl_module
    atm_module_incs=src/http/modules/perl
    atm_module_deps=src/http/modules/perl/atm_http_perl_module.h
    atm_module_srcs=src/http/modules/perl/atm_http_perl_module.c
    atm_module_libs=PERL
    atm_module_link=$HTTP_PERL

    . auto/module
fi

if [ $HTTP_MEMCACHED = YES ]; then
    atm_module_name=atm_http_memcached_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_memcached_module.c
    atm_module_libs=
    atm_module_link=$HTTP_MEMCACHED

    . auto/module
fi

if [ $HTTP_EMPTY_GIF = YES ]; then
    atm_module_name=atm_http_empty_gif_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_empty_gif_module.c
    atm_module_libs=
    atm_module_link=$HTTP_EMPTY_GIF

    . auto/module
fi

if [ $HTTP_BROWSER = YES ]; then
    atm_module_name=atm_http_browser_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_browser_module.c
    atm_module_libs=
    atm_module_link=$HTTP_BROWSER

    . auto/module
fi

if [ $HTTP_SECURE_LINK = YES ]; then
    atm_module_name=atm_http_secure_link_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_secure_link_module.c
    atm_module_libs=
    atm_module_link=$HTTP_SECURE_LINK

    . auto/module
fi

if [ $HTTP_DEGRADATION = YES ]; then
    have=ATM_HTTP_DEGRADATION . auto/have

    atm_module_name=atm_http_degradation_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_degradation_module.c
    atm_module_libs=
    atm_module_link=$HTTP_DEGRADATION

    . auto/module
fi

if [ $HTTP_FLV = YES ]; then
    atm_module_name=atm_http_flv_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_flv_module.c
    atm_module_libs=
    atm_module_link=$HTTP_FLV

    . auto/module
fi

if [ $HTTP_MP4 = YES ]; then
    atm_module_name=atm_http_mp4_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_mp4_module.c
    atm_module_libs=
    atm_module_link=$HTTP_MP4

    . auto/module
fi

if [ $HTTP_UPSTREAM_HASH = YES ]; then
    atm_module_name=atm_http_upstream_hash_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_upstream_hash_module.c
    atm_module_libs=
    atm_module_link=$HTTP_UPSTREAM_HASH

    . auto/module
fi

if [ $HTTP_UPSTREAM_IP_HASH = YES ]; then
    atm_module_name=atm_http_upstream_ip_hash_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_upstream_ip_hash_module.c
    atm_module_libs=
    atm_module_link=$HTTP_UPSTREAM_IP_HASH

    . auto/module
fi

if [ $HTTP_UPSTREAM_LEAST_CONN = YES ]; then
    atm_module_name=atm_http_upstream_least_conn_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_upstream_least_conn_module.c
    atm_module_libs=
    atm_module_link=$HTTP_UPSTREAM_LEAST_CONN

    . auto/module
fi

if [ $HTTP_UPSTREAM_KEEPALIVE = YES ]; then
    atm_module_name=atm_http_upstream_keepalive_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_upstream_keepalive_module.c
    atm_module_libs=
    atm_module_link=$HTTP_UPSTREAM_KEEPALIVE

    . auto/module
fi

if [ $HTTP_UPSTREAM_ZONE = YES ]; then
    have=ATM_HTTP_UPSTREAM_ZONE . auto/have

    atm_module_name=atm_http_upstream_zone_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_upstream_zone_module.c
    atm_module_libs=
    atm_module_link=$HTTP_UPSTREAM_ZONE

    . auto/module
fi

if [ $HTTP_STUB_STATUS = YES ]; then
    have=ATM_STAT_STUB . auto/have

    atm_module_name=atm_http_stub_status_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/http/modules/atm_http_stub_status_module.c
    atm_module_libs=
    atm_module_link=$HTTP_STUB_STATUS

    . auto/module
fi


if [ $MAIL != NO ]; then
    MAIL_MODULES=
    MAIL_DEPS=
    MAIL_INCS=

    atm_module_type=MAIL
    atm_module_libs=
    atm_module_link=YES

    atm_module_order=

    atm_module_name="atm_mail_module atm_mail_core_module"
    atm_module_incs="src/mail"
    atm_module_deps="src/mail/atm_mail.h"
    atm_module_srcs="src/mail/atm_mail.c \
                     src/mail/atm_mail_core_module.c \
                     src/mail/atm_mail_handler.c \
                     src/mail/atm_mail_parse.c"

    . auto/module

    atm_module_incs=

    if [ $MAIL_SSL = YES ]; then
        USE_OPENSSL=YES
        have=ATM_MAIL_SSL . auto/have

        atm_module_name=atm_mail_ssl_module
        atm_module_deps=src/mail/atm_mail_ssl_module.h
        atm_module_srcs=src/mail/atm_mail_ssl_module.c

        . auto/module
    fi

    if [ $MAIL_POP3 = YES ]; then
        atm_module_name=atm_mail_pop3_module
        atm_module_deps=src/mail/atm_mail_pop3_module.h
        atm_module_srcs="src/mail/atm_mail_pop3_module.c \
                         src/mail/atm_mail_pop3_handler.c"

        . auto/module
    fi

    if [ $MAIL_IMAP = YES ]; then
        atm_module_name=atm_mail_imap_module
        atm_module_deps=src/mail/atm_mail_imap_module.h
        atm_module_srcs="src/mail/atm_mail_imap_module.c \
                         src/mail/atm_mail_imap_handler.c"

        . auto/module
    fi

    if [ $MAIL_SMTP = YES ]; then
        atm_module_name=atm_mail_smtp_module
        atm_module_deps=src/mail/atm_mail_smtp_module.h
        atm_module_srcs="src/mail/atm_mail_smtp_module.c \
                         src/mail/atm_mail_smtp_handler.c"

        . auto/module
    fi

    atm_module_name=atm_mail_auth_http_module
    atm_module_deps=
    atm_module_srcs=src/mail/atm_mail_auth_http_module.c

    . auto/module

    atm_module_name=atm_mail_proxy_module
    atm_module_deps=
    atm_module_srcs=src/mail/atm_mail_proxy_module.c

    . auto/module
fi


if [ $STREAM != NO ]; then
    STREAM_MODULES=
    STREAM_DEPS=
    STREAM_INCS=

    atm_module_type=STREAM

    atm_module_order=

    atm_module_name="atm_stream_module \
                     atm_stream_core_module \
                     atm_stream_log_module \
                     atm_stream_proxy_module \
                     atm_stream_upstream_module \
                     atm_stream_write_filter_module"
    atm_module_incs="src/stream"
    atm_module_deps="src/stream/atm_stream.h \
                     src/stream/atm_stream_variables.h \
                     src/stream/atm_stream_script.h \
                     src/stream/atm_stream_upstream.h \
                     src/stream/atm_stream_upstream_round_robin.h"
    atm_module_srcs="src/stream/atm_stream.c \
                     src/stream/atm_stream_variables.c \
                     src/stream/atm_stream_script.c \
                     src/stream/atm_stream_handler.c \
                     src/stream/atm_stream_core_module.c \
                     src/stream/atm_stream_log_module.c \
                     src/stream/atm_stream_proxy_module.c \
                     src/stream/atm_stream_upstream.c \
                     src/stream/atm_stream_upstream_round_robin.c \
                     src/stream/atm_stream_write_filter_module.c"

    . auto/module

    atm_module_incs=

    if [ $STREAM_SSL = YES ]; then
        USE_OPENSSL=YES
        have=ATM_STREAM_SSL . auto/have

        atm_module_name=atm_stream_ssl_module
        atm_module_deps=src/stream/atm_stream_ssl_module.h
        atm_module_srcs=src/stream/atm_stream_ssl_module.c
        atm_module_libs=
        atm_module_link=$STREAM_SSL

        . auto/module
    fi

    if [ $STREAM_REALIP = YES ]; then
        atm_module_name=atm_stream_realip_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_realip_module.c
        atm_module_libs=
        atm_module_link=$STREAM_REALIP

        . auto/module
    fi

    if [ $STREAM_LIMIT_CONN = YES ]; then
        atm_module_name=atm_stream_limit_conn_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_limit_conn_module.c
        atm_module_libs=
        atm_module_link=$STREAM_LIMIT_CONN

        . auto/module
    fi

    if [ $STREAM_ACCESS = YES ]; then
        atm_module_name=atm_stream_access_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_access_module.c
        atm_module_libs=
        atm_module_link=$STREAM_ACCESS

        . auto/module
    fi

    if [ $STREAM_GEO = YES ]; then
        atm_module_name=atm_stream_geo_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_geo_module.c
        atm_module_libs=
        atm_module_link=$STREAM_GEO

        . auto/module
    fi

    if [ $STREAM_GEOIP != NO ]; then
        atm_module_name=atm_stream_geoip_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_geoip_module.c
        atm_module_libs=GEOIP
        atm_module_link=$STREAM_GEOIP

        . auto/module
    fi

    if [ $STREAM_MAP = YES ]; then
        atm_module_name=atm_stream_map_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_map_module.c
        atm_module_libs=
        atm_module_link=$STREAM_MAP

        . auto/module
    fi

    if [ $STREAM_SPLIT_CLIENTS = YES ]; then
        atm_module_name=atm_stream_split_clients_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_split_clients_module.c
        atm_module_libs=
        atm_module_link=$STREAM_SPLIT_CLIENTS

        . auto/module
    fi

    if [ $STREAM_RETURN = YES ]; then
        atm_module_name=atm_stream_return_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_return_module.c
        atm_module_libs=
        atm_module_link=$STREAM_RETURN

        . auto/module
    fi

    if [ $STREAM_UPSTREAM_HASH = YES ]; then
        atm_module_name=atm_stream_upstream_hash_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_upstream_hash_module.c
        atm_module_libs=
        atm_module_link=$STREAM_UPSTREAM_HASH

        . auto/module
    fi

    if [ $STREAM_UPSTREAM_LEAST_CONN = YES ]; then
        atm_module_name=atm_stream_upstream_least_conn_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_upstream_least_conn_module.c
        atm_module_libs=
        atm_module_link=$STREAM_UPSTREAM_LEAST_CONN

        . auto/module
    fi

    if [ $STREAM_UPSTREAM_ZONE = YES ]; then
        have=ATM_STREAM_UPSTREAM_ZONE . auto/have

        atm_module_name=atm_stream_upstream_zone_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_upstream_zone_module.c
        atm_module_libs=
        atm_module_link=$STREAM_UPSTREAM_ZONE

        . auto/module
    fi

    if [ $STREAM_SSL_PREREAD = YES ]; then
        atm_module_name=atm_stream_ssl_preread_module
        atm_module_deps=
        atm_module_srcs=src/stream/atm_stream_ssl_preread_module.c
        atm_module_libs=
        atm_module_link=$STREAM_SSL_PREREAD

        . auto/module
    fi
fi


#if [ -r $ATM_BUILD/auto ]; then
#    . $ATM_BUILD/auto
#fi


if test -n "$ATM_ADDONS"; then

    echo configuring additional modules

    for atm_addon_dir in $ATM_ADDONS
    do
        echo "adding module in $atm_addon_dir"

        atm_module_type=
        atm_module_name=
        atm_module_incs=
        atm_module_deps=
        atm_module_srcs=
        atm_module_libs=
        atm_module_order=
        atm_module_link=ADDON

        if test -f $atm_addon_dir/config; then
            . $atm_addon_dir/config

            echo " + $atm_addon_name was configured"

        else
            echo "$0: error: no $atm_addon_dir/config was found"
            exit 1
        fi
    done
fi


if test -n "$DYNAMIC_ADDONS"; then

    echo configuring additional dynamic modules

    for atm_addon_dir in $DYNAMIC_ADDONS
    do
        echo "adding module in $atm_addon_dir"

        atm_module_type=
        atm_module_name=
        atm_module_incs=
        atm_module_deps=
        atm_module_srcs=
        atm_module_libs=
        atm_module_order=
        atm_module_link=DYNAMIC

        if test -f $atm_addon_dir/config; then
            . $atm_addon_dir/config

            echo " + $atm_addon_name was configured"

        else
            echo "$0: error: no $atm_addon_dir/config was found"
            exit 1
        fi
    done
fi


if [ $USE_OPENSSL = YES ]; then
    atm_module_type=CORE
    atm_module_name=atm_openssl_module
    atm_module_incs=
    atm_module_deps=src/event/atm_event_openssl.h
    atm_module_srcs="src/event/atm_event_openssl.c
                     src/event/atm_event_openssl_stapling.c"
    atm_module_libs=
    atm_module_link=YES
    atm_module_order=

    . auto/module
fi


if [ $USE_PCRE = YES ]; then
    atm_module_type=CORE
    atm_module_name=atm_regex_module
    atm_module_incs=
    atm_module_deps=src/core/atm_regex.h
    atm_module_srcs=src/core/atm_regex.c
    atm_module_libs=
    atm_module_link=YES
    atm_module_order=

    . auto/module
fi


modules="$CORE_MODULES $EVENT_MODULES"


# thread pool module should be initialized after events
if [ $USE_THREADS = YES ]; then
    modules="$modules $THREAD_POOL_MODULE"
fi


if [ $HTTP = YES ]; then
    modules="$modules $HTTP_MODULES $HTTP_FILTER_MODULES \
             $HTTP_AUX_FILTER_MODULES $HTTP_INIT_FILTER_MODULES"

    ATM_ADDON_DEPS="$ATM_ADDON_DEPS \$(HTTP_DEPS)"
fi


if [ $MAIL != NO ]; then

    if [ $MAIL = YES ]; then
        modules="$modules $MAIL_MODULES"

    elif [ $MAIL = DYNAMIC ]; then
        atm_module_name=$MAIL_MODULES
        atm_module_incs=
        atm_module_deps=
        atm_module_srcs=$MAIL_SRCS
        atm_module_libs=
        atm_module_link=DYNAMIC

        . auto/module
    fi

    ATM_ADDON_DEPS="$ATM_ADDON_DEPS \$(MAIL_DEPS)"
fi


if [ $STREAM != NO ]; then

    if [ $STREAM = YES ]; then
        modules="$modules $STREAM_MODULES"

    elif [ $STREAM = DYNAMIC ]; then
        atm_module_name=$STREAM_MODULES
        atm_module_incs=
        atm_module_deps=
        atm_module_srcs=$STREAM_SRCS
        atm_module_libs=
        atm_module_link=DYNAMIC

        . auto/module
    fi

    ATM_ADDON_DEPS="$ATM_ADDON_DEPS \$(STREAM_DEPS)"
fi


atm_module_type=MISC
MISC_MODULES=

if [ $ATM_GOOGLE_PERFTOOLS = YES ]; then
    atm_module_name=atm_google_perftools_module
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/misc/atm_google_perftools_module.c
    atm_module_libs=
    atm_module_link=$ATM_GOOGLE_PERFTOOLS

    . auto/module
fi

if [ $ATM_CPP_TEST = YES ]; then
    atm_module_name=
    atm_module_incs=
    atm_module_deps=
    atm_module_srcs=src/misc/atm_cpp_test_module.cpp
    atm_module_libs=-lstdc++
    atm_module_link=$ATM_CPP_TEST

    . auto/module
fi

modules="$modules $MISC_MODULES"


if [ $ATM_COMPAT = YES ]; then
    have=ATM_COMPAT . auto/have
    have=ATM_HTTP_GZIP . auto/have
    have=ATM_HTTP_DAV . auto/have
    have=ATM_HTTP_REALIP . auto/have
    have=ATM_HTTP_X_FORWARDED_FOR . auto/have
    have=ATM_HTTP_HEADERS . auto/have
    have=ATM_HTTP_UPSTREAM_ZONE . auto/have
    have=ATM_STREAM_UPSTREAM_ZONE . auto/have
fi


cat << END                                    > $ATM_MODULES_C

#include <atm_config.h>
#include <atm_core.h>

$ATM_PRAGMA

END

for mod in $modules
do
    echo "extern atm_module_t  $mod;"         >> $ATM_MODULES_C
done

echo                                          >> $ATM_MODULES_C
echo 'atm_module_t *atm_modules[] = {'        >> $ATM_MODULES_C

for mod in $modules
do
    echo "    &$mod,"                         >> $ATM_MODULES_C
done

cat << END                                    >> $ATM_MODULES_C
    NULL
};

END

echo 'char *atm_module_names[] = {'           >> $ATM_MODULES_C

for mod in $modules
do
    echo "    \"$mod\","                      >> $ATM_MODULES_C
done

cat << END                                    >> $ATM_MODULES_C
    NULL
};

END
